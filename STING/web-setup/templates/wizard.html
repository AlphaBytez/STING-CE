<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STING-CE Setup Wizard | First-Run Configuration</title>
    <meta name="description" content="STING - Secure Trusted Intelligence and Networking Guardian - First-Run Setup Wizard">
    <link rel="icon" type="image/png" href="/static/sting-logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .step-indicator {
            @apply w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all;
        }
        .step-indicator.active {
            @apply bg-amber-400 text-slate-900 ring-2 ring-amber-500;
        }
        .step-indicator.completed {
            @apply bg-lime-500 text-slate-900;
        }
        .step-indicator.pending {
            @apply bg-slate-700 text-slate-400;
        }
        .step-content {
            display: none;
        }
        .step-content.active {
            display: block;
        }
        .test-button:disabled {
            @apply opacity-50 cursor-not-allowed;
        }

        /* Glass morphism cards */
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px) saturate(140%);
            border: 1px solid rgba(148, 163, 184, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .glass-card-light {
            background: rgba(51, 65, 85, 0.6);
            backdrop-filter: blur(10px) saturate(130%);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        /* Ensure all text is readable */
        .glass-card, .glass-card-light {
            color: rgb(226, 232, 240); /* slate-200 */
        }

        .glass-card h2, .glass-card-light h2 {
            color: rgb(251, 191, 36); /* amber-400 */
        }

        .glass-card p, .glass-card-light p {
            color: rgb(203, 213, 225); /* slate-300 */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header with STING Logo -->
        <div class="text-center mb-8">
            <div class="mb-4 flex justify-center">
                <picture>
                    <source srcset="/static/sting-logo.webp" type="image/webp">
                    <img src="/static/sting-logo.png" alt="STING Logo" class="h-24 w-24 object-contain drop-shadow-lg">
                </picture>
            </div>
            <h1 class="text-4xl font-bold text-amber-400 mb-2">STING-CE Setup Wizard</h1>
            <p class="text-slate-400 text-sm uppercase tracking-wider mb-2">Secure Trusted Intelligence and Networking Guardian</p>
            <p class="text-slate-300">Configure your STING platform in a few easy steps</p>
            <p class="text-slate-500 text-sm mt-2">üçØ Preparing your Hive for deployment</p>
        </div>

        <!-- Progress Steps -->
        <div class="glass-card rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4" id="progress-steps">
                    <!-- Steps dynamically generated -->
                </div>
            </div>
            <div class="mt-4 h-2 bg-slate-700 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-amber-400 to-amber-500 transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- Main Wizard Card -->
        <div class="glass-card rounded-lg shadow-xl p-8">
            <!-- Step 1: Welcome & System Basics -->
            <div class="step-content active" data-step="1">
                <h2 class="text-2xl font-bold text-amber-400 mb-4">üè† Welcome to STING-CE!</h2>
                <p class="text-slate-300 mb-6">Let's configure your system settings to get your Hive buzzing.</p>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Hostname</label>
                        <input type="text" id="hostname" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 focus:ring-2 focus:ring-amber-400 focus:border-transparent" placeholder="sting-ce">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Timezone</label>
                        <select id="timezone" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 focus:ring-2 focus:ring-amber-400">
                            <option value="UTC">UTC</option>
                            <option value="America/New_York">America/New_York</option>
                            <option value="America/Chicago">America/Chicago</option>
                            <option value="America/Denver">America/Denver</option>
                            <option value="America/Los_Angeles">America/Los_Angeles</option>
                            <option value="Europe/London">Europe/London</option>
                            <option value="Europe/Paris">Europe/Paris</option>
                            <option value="Asia/Tokyo">Asia/Tokyo</option>
                        </select>
                    </div>

                    <div class="glass-card-light rounded-lg p-4">
                        <p class="text-sm text-slate-200">
                            <strong class="text-slate-100">Current IP:</strong> <span id="current-ip">Loading...</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Step 2: Data Disk -->
            <div class="step-content" data-step="2">
                <h2 class="text-2xl font-bold text-amber-400 mb-4">üíæ Data Disk Configuration <span class="text-sm text-slate-400 font-normal">(Optional)</span></h2>
                <p class="text-slate-300 mb-6">Attach and configure a separate disk for data storage (where the honey is stored). You can skip this step and use the system disk.</p>

                <button onclick="detectDisks()" class="mb-4 bg-amber-400 text-slate-900 font-medium px-4 py-2 rounded-lg hover:bg-amber-500">
                    Detect Disks
                </button>

                <div id="disk-list" class="space-y-2">
                    <p class="text-slate-300">Click "Detect Disks" to find available disks</p>
                </div>

                <!-- Enhanced Safety Warning -->
                <div class="mt-6 bg-red-900/30 border-2 border-red-600 rounded-lg p-5">
                    <div class="flex items-start gap-3">
                        <div class="text-3xl">‚ö†Ô∏è</div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-red-400 mb-2">DANGER ZONE - Disk Formatting</h3>
                            <p class="text-red-300 mb-3">
                                <strong>Formatting will PERMANENTLY ERASE all data on the selected disk.</strong><br>
                                This action cannot be undone!
                            </p>

                            <div class="bg-slate-800/50 rounded p-3 mt-3">
                                <p class="text-sm font-semibold text-green-400 mb-2">‚úì Safety Checks Enabled:</p>
                                <ul class="text-xs text-slate-300 space-y-1 ml-4">
                                    <li>‚úì System disks (/, /boot, /home) are protected</li>
                                    <li>‚úì Root filesystem disk is blocked</li>
                                    <li>‚úì Currently mounted partitions are blocked</li>
                                    <li>‚úì Swap partitions are protected</li>
                                    <li>‚úì Only unmounted, non-system disks are shown</li>
                                    <li>‚úì Device path validation prevents injection attacks</li>
                                </ul>
                            </div>

                            <p class="text-xs text-amber-300 mt-3">
                                <strong>üí° Tip:</strong> If you're unsure, skip this step. STING will work fine using your system disk for data storage.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Admin Account -->
            <div class="step-content" data-step="3">
                <h2 class="text-2xl font-bold text-amber-400 mb-4">üë§ Create Admin Account</h2>
                <p class="text-slate-300 mb-6">Set up the Queen Bee administrator account.</p>

                <div class="glass-card-light rounded-lg p-4 mb-6">
                    <p class="text-sm text-slate-200">
                        <strong class="text-amber-400">üîê STING is fully passwordless!</strong><br>
                        Your admin account will be created automatically after installation completes.
                        You'll receive a magic link via email to verify and set up security (TOTP, passkeys).
                    </p>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Admin Email Address</label>
                        <input type="email" id="admin-email" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 text-slate-100 rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="admin@sting.local" value="admin@sting.local">
                        <p class="text-xs text-slate-300 mt-2">
                            üí° Default: <code class="text-amber-400 bg-slate-800/50 px-1 rounded">admin@sting.local</code> works with Mailpit for testing.<br>
                            ‚ö†Ô∏è For production, use a real email address and configure SMTP in Step 5.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Step 4: LLM Configuration -->
            <div class="step-content" data-step="4">
                <h2 class="text-2xl font-bold text-amber-400 mb-4">ü§ñ LLM Backend Configuration</h2>
                <p class="text-slate-300 mb-6">Configure your AI model endpoint to power the Worker Bees.</p>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Ollama Endpoint URL</label>
                        <input type="url" id="llm-endpoint" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 text-slate-100 rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="http://localhost:11434">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Default Model</label>
                        <input type="text" id="llm-model" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 text-slate-100 rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="phi4:mini" value="phi4:mini">
                    </div>

                    <div class="flex gap-3">
                        <button onclick="testLLMEndpoint()" class="bg-lime-500 text-slate-900 font-medium px-4 py-2 rounded-lg hover:bg-lime-600">
                            Test Connection
                        </button>

                        <button
                            id="save-llm-config-btn"
                            onclick="saveLLMConfig()"
                            class="bg-green-600 text-white font-medium px-4 py-2 rounded-lg hover:bg-green-700 hidden"
                        >
                            ‚úì Save Tested Configuration
                        </button>
                    </div>

                    <div id="llm-test-result" class="mt-4"></div>

                    <div id="llm-config-saved" class="mt-4 hidden">
                        <div class="bg-green-900/30 border-2 border-green-600 rounded-lg p-4">
                            <p class="text-green-400 font-semibold">
                                ‚úì Configuration Saved!
                            </p>
                            <p class="text-green-300 text-sm mt-2">
                                Your tested LLM endpoint will be used during installation:
                            </p>
                            <ul class="text-xs text-slate-300 mt-2 ml-4">
                                <li>Endpoint: <code id="saved-endpoint" class="text-green-400"></code></li>
                                <li>Model: <code id="saved-model" class="text-green-400"></code></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Email/SMTP -->
            <div class="step-content" data-step="5">
                <h2 class="text-2xl font-bold text-amber-400 mb-4">üìß Email Configuration (Optional)</h2>
                <p class="text-slate-300 mb-6">Configure SMTP for notification delivery by carrier bees.</p>

                <div class="mb-4">
                    <label class="inline-flex items-center">
                        <input type="checkbox" id="email-enabled" class="form-checkbox h-5 w-5 text-amber-500">
                        <span class="ml-2 text-slate-300">Enable Email Notifications</span>
                    </label>
                </div>

                <div id="email-config" class="space-y-4" style="display: none;">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">SMTP Host</label>
                        <input type="text" id="smtp-host" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 text-slate-100 rounded-lg focus:ring-2 focus:ring-amber-500">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Port</label>
                            <input type="number" id="smtp-port" value="587" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 text-slate-100 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Username</label>
                            <input type="text" id="smtp-username" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 text-slate-100 rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Password</label>
                        <input type="password" id="smtp-password" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 text-slate-100 rounded-lg focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>
            </div>

            <!-- Step 6: SSL/TLS -->
            <div class="step-content" data-step="6">
                <h2 class="text-2xl font-bold text-amber-400 mb-4">üîí SSL/TLS Configuration</h2>
                <p class="text-slate-300 mb-6">Configure HTTPS certificates to protect the Hive.</p>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-4">Certificate Type</label>
                        <div class="space-y-2">
                            <label class="inline-flex items-center">
                                <input type="radio" name="ssl-type" value="self-signed" checked class="form-radio h-4 w-4 text-amber-500">
                                <span class="ml-2">Generate Self-Signed Certificate</span>
                            </label>
                            <br>
                            <label class="inline-flex items-center">
                                <input type="radio" name="ssl-type" value="upload" class="form-radio h-4 w-4 text-amber-500">
                                <span class="ml-2">Upload Existing Certificate</span>
                            </label>
                        </div>
                    </div>

                    <div id="ssl-upload" style="display: none;">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-slate-300 mb-2">Certificate File (.crt)</label>
                            <input type="file" id="ssl-cert" accept=".crt,.pem" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 text-slate-100 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Private Key (.key)</label>
                            <input type="file" id="ssl-key" accept=".key,.pem" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 text-slate-100 rounded-lg">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 7: Review & Apply -->
            <div class="step-content" data-step="7">
                <h2 class="text-2xl font-bold text-amber-400 mb-4">‚úÖ Review Configuration</h2>
                <p class="text-slate-300 mb-6">Please review your Hive settings before deploying.</p>

                <div id="config-review" class="glass-card-light rounded-lg p-6 mb-6">
                    <!-- Config review populated here -->
                </div>

                <div id="dev-mode-notice" class="bg-blue-900/20 border border-blue-700 rounded-lg p-4 mb-6" style="display: none;">
                    <p class="text-sm text-blue-300">
                        <strong>üí° Dev Mode Active:</strong> Installation will be simulated. Configuration will be saved but the installer won't run.
                        Deploy to a real VM for actual installation.
                    </p>
                </div>

                <div class="bg-red-900/20 border border-red-700 rounded-lg p-4 mb-6" id="prod-warning">
                    <p class="text-sm text-red-300">
                        <strong>‚ö†Ô∏è Warning:</strong> Applying this configuration will install and start STING. This wizard will be disabled.
                    </p>
                </div>

                <button onclick="applyConfiguration()" class="bg-lime-500 text-slate-900 px-6 py-3 rounded-lg hover:bg-lime-600 font-bold text-lg">
                    üöÄ Apply Configuration & Deploy STING
                </button>
            </div>

            <!-- Step 8: Installation Progress (Hidden until install starts) -->
            <div class="step-content" data-step="8" style="display: none;">
                <h2 class="text-2xl font-bold text-amber-400 mb-4">üöÄ Installing STING</h2>
                <p class="text-slate-300 mb-6">Building your Hive... This may take 15-30 minutes.</p>

                <div class="glass-card-light rounded-lg p-6 mb-6">
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-slate-200">Installation Progress</span>
                            <span class="text-sm text-slate-300" id="install-status">Starting...</span>
                        </div>
                        <div class="w-full bg-slate-800/50 rounded-full h-2">
                            <div id="install-progress-bar" class="bg-gradient-to-r from-amber-400 to-amber-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Live log output -->
                    <div class="bg-slate-900/80 rounded-lg p-4 h-96 overflow-y-auto font-mono text-xs border border-slate-700/50">
                        <div id="install-log" class="text-lime-400 whitespace-pre-wrap"></div>
                    </div>
                </div>

                <div class="bg-amber-900/20 border border-amber-700 rounded-lg p-4">
                    <p class="text-sm text-amber-300">
                        <strong>üí° Tip:</strong> Don't close this window. The installation will continue in the background, but you won't be able to see the progress.
                    </p>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="flex justify-between mt-8 pt-6 border-t border-slate-700">
                <button onclick="previousStep()" id="prev-btn" class="bg-slate-700 text-slate-300 px-6 py-2 rounded-lg hover:bg-slate-600 disabled:opacity-50" disabled>
                    Previous
                </button>
                <button onclick="nextStep()" id="next-btn" class="bg-amber-400 text-slate-900 font-medium px-6 py-2 rounded-lg hover:bg-amber-500">
                    Next
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 7;
        let configData = {};

        const stepLabels = [
            'System', 'Data Disk', 'Admin', 'LLM', 'Email', 'SSL', 'Review'
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            renderProgressSteps();
            loadSystemInfo();
            updateProgress();

            // Email toggle
            document.getElementById('email-enabled').addEventListener('change', function() {
                document.getElementById('email-config').style.display = this.checked ? 'block' : 'none';
            });

            // SSL type toggle
            document.querySelectorAll('input[name="ssl-type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('ssl-upload').style.display =
                        this.value === 'upload' ? 'block' : 'none';
                });
            });
        });

        function renderProgressSteps() {
            const container = document.getElementById('progress-steps');
            container.innerHTML = '';

            for (let i = 1; i <= totalSteps; i++) {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'flex items-center';
                stepDiv.innerHTML = `
                    <div class="step-indicator ${i === currentStep ? 'active' : i < currentStep ? 'completed' : 'pending'}" id="step-${i}">
                        ${i}
                    </div>
                    ${i < totalSteps ? '<div class="w-8 h-0.5 bg-gray-300 mx-2"></div>' : ''}
                `;
                container.appendChild(stepDiv);
            }
        }

        function updateProgress() {
            const percentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
            document.getElementById('progress-bar').style.width = percentage + '%';

            // Show/hide steps
            document.querySelectorAll('.step-content').forEach((el, index) => {
                el.classList.toggle('active', index + 1 === currentStep);
            });

            // Update buttons
            document.getElementById('prev-btn').disabled = currentStep === 1;
            document.getElementById('next-btn').style.display = currentStep === totalSteps ? 'none' : 'block';

            renderProgressSteps();
        }

        async function nextStep() {
            // Save current step data
            await saveStepData(currentStep);

            if (currentStep < totalSteps) {
                currentStep++;
                updateProgress();

                // Special handling for review step
                if (currentStep === 7) {
                    await renderConfigReview();
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateProgress();
            }
        }

        async function loadSystemInfo() {
            try {
                const response = await fetch('/api/system-info');
                const data = await response.json();

                document.getElementById('hostname').value = data.hostname;
                document.getElementById('timezone').value = data.timezone;
                document.getElementById('current-ip').textContent = data.ip_address;
            } catch (error) {
                console.error('Failed to load system info:', error);
            }
        }

        async function detectDisks() {
            try {
                const response = await fetch('/api/detect-disks');
                const data = await response.json();

                const listEl = document.getElementById('disk-list');
                if (data.disks.length === 0) {
                    listEl.innerHTML = '<p class="text-slate-300">No unmounted disks found</p>';
                    return;
                }

                listEl.innerHTML = data.disks.map(disk => `
                    <div class="glass-card-light rounded-lg p-4 flex justify-between items-center">
                        <div class="text-slate-100">
                            <strong class="text-slate-50">${disk.device}</strong> - ${disk.size}
                        </div>
                        <button onclick="formatDisk('${disk.device}')" class="bg-red-500 text-white font-medium px-4 py-2 rounded hover:bg-red-600">
                            Format & Mount
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to detect disks:', error);
            }
        }

        async function formatDisk(device) {
            if (!confirm(`Format ${device}? This will erase all data!`)) {
                return;
            }

            try {
                const response = await fetch('/api/format-disk', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({device})
                });

                const data = await response.json();
                alert(data.message);

                if (data.success) {
                    detectDisks();
                }
            } catch (error) {
                alert('Failed to format disk: ' + error);
            }
        }

        async function testLLMEndpoint() {
            const endpoint = document.getElementById('llm-endpoint').value;
            const model = document.getElementById('llm-model').value;
            const resultDiv = document.getElementById('llm-test-result');

            resultDiv.innerHTML = '<div class="bg-amber-400/90 border border-amber-500 rounded-lg p-4 backdrop-blur-sm"><p class="text-slate-900 font-semibold">Testing connection...</p></div>';

            try {
                const response = await fetch('/api/test-llm', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({endpoint, model})
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="bg-amber-400/90 border border-amber-500 rounded-lg p-4 backdrop-blur-sm">
                            <p class="text-black font-semibold"><strong>‚úì Success!</strong> ${data.message}</p>
                            ${data.models.length > 0 ? `<p class="text-sm text-black mt-2">Available models: ${data.models.join(', ')}</p>` : ''}
                        </div>
                    `;

                    // Show save button after successful test
                    document.getElementById('save-llm-config-btn').classList.remove('hidden');
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-amber-400/90 border border-amber-600 rounded-lg p-4 backdrop-blur-sm">
                            <p class="text-black font-semibold"><strong>‚ö† Failed:</strong> ${data.message}</p>
                        </div>
                    `;

                    // Hide save button on failure
                    document.getElementById('save-llm-config-btn').classList.add('hidden');
                    document.getElementById('llm-config-saved').classList.add('hidden');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="bg-amber-400/90 border border-amber-600 rounded-lg p-4 backdrop-blur-sm">
                        <p class="text-black font-semibold"><strong>‚ö† Connection error:</strong> ${error}</p>
                    </div>
                `;
            }
        }

        function saveLLMConfig() {
            const endpoint = document.getElementById('llm-endpoint').value;
            const model = document.getElementById('llm-model').value;

            // Save to config data
            configData.llm = {
                endpoint: endpoint,
                model: model
            };

            // Hide save button
            document.getElementById('save-llm-config-btn').classList.add('hidden');

            // Show confirmation
            document.getElementById('llm-config-saved').classList.remove('hidden');
            document.getElementById('saved-endpoint').textContent = endpoint;
            document.getElementById('saved-model').textContent = model;

            // Persist to backend
            fetch('/api/save-step', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({step: 4, data: {llm: {endpoint, model}}})
            });
        }

        async function saveStepData(step) {
            const stepData = {};

            // Collect data based on step
            switch(step) {
                case 1:
                    stepData.system = {
                        hostname: document.getElementById('hostname').value,
                        timezone: document.getElementById('timezone').value
                    };
                    break;
                case 3:
                    // Default to admin@sting.local if email is empty
                    const adminEmail = document.getElementById('admin-email').value.trim();
                    stepData.admin = {
                        email: adminEmail || 'admin@sting.local'
                    };
                    break;
                case 4:
                    stepData.llm = {
                        endpoint: document.getElementById('llm-endpoint').value,
                        model: document.getElementById('llm-model').value
                    };
                    break;
                case 5:
                    if (document.getElementById('email-enabled').checked) {
                        stepData.email = {
                            host: document.getElementById('smtp-host').value,
                            port: document.getElementById('smtp-port').value,
                            username: document.getElementById('smtp-username').value,
                            password: document.getElementById('smtp-password').value
                        };
                    }
                    break;
            }

            if (Object.keys(stepData).length > 0) {
                configData = {...configData, ...stepData};

                await fetch('/api/save-step', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({step, data: stepData})
                });
            }
        }

        async function renderConfigReview() {
            const reviewDiv = document.getElementById('config-review');
            reviewDiv.innerHTML = `
                <pre class="text-sm bg-slate-900 p-4 rounded border border-slate-600 text-lime-400 font-mono">${JSON.stringify(configData, null, 2)}</pre>
            `;

            // Check if we're in dev mode and show appropriate warning
            try {
                const response = await fetch('/api/state');
                const state = await response.json();

                if (state.dev_mode) {
                    document.getElementById('dev-mode-notice').style.display = 'block';
                    document.getElementById('prod-warning').style.display = 'none';
                } else {
                    document.getElementById('dev-mode-notice').style.display = 'none';
                    document.getElementById('prod-warning').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to check dev mode:', error);
            }
        }

        async function applyConfiguration() {
            if (!confirm('Apply configuration and install STING? This cannot be undone.')) {
                return;
            }

            // Switch to installation progress view (Step 8)
            document.querySelectorAll('.step-content').forEach(step => step.style.display = 'none');
            document.querySelector('[data-step="8"]').style.display = 'block';
            document.getElementById('prev-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';

            try {
                // Start installation
                const response = await fetch('/api/apply-config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({config: configData})
                });

                const data = await response.json();

                if (data.install_id) {
                    // Start streaming logs
                    streamInstallLogs(data.install_id);
                } else if (data.success) {
                    // Installation completed immediately (shouldn't happen)
                    showInstallComplete(data.redirect_url);
                } else {
                    showInstallError(data.error || 'Unknown error');
                }
            } catch (error) {
                showInstallError('Installation failed: ' + error);
            }
        }

        async function streamInstallLogs(installId) {
            const logDiv = document.getElementById('install-log');
            const statusSpan = document.getElementById('install-status');
            const progressBar = document.getElementById('install-progress-bar');

            let lastLength = 0;

            const pollLogs = async () => {
                try {
                    const response = await fetch(`/api/install-log/${installId}`);
                    const data = await response.json();

                    if (data.log) {
                        logDiv.textContent = data.log;
                        // Auto-scroll to bottom
                        logDiv.parentElement.scrollTop = logDiv.parentElement.scrollHeight;
                    }

                    if (data.status) {
                        statusSpan.textContent = data.status;
                    }

                    if (data.progress !== undefined) {
                        progressBar.style.width = data.progress + '%';
                    }

                    if (data.completed) {
                        if (data.success) {
                            progressBar.style.width = '100%';
                            statusSpan.textContent = 'Installation Complete! ‚úÖ';
                            setTimeout(() => {
                                showInstallComplete(data.redirect_url, data.admin_email);
                            }, 2000);
                        } else {
                            showInstallError(data.error || 'Installation failed');
                        }
                    } else {
                        // Continue polling
                        setTimeout(pollLogs, 2000);
                    }
                } catch (error) {
                    console.error('Error polling logs:', error);
                    setTimeout(pollLogs, 5000); // Retry after longer delay
                }
            };

            pollLogs();
        }

        function showInstallComplete(redirectUrl, adminEmail) {
            const logDiv = document.getElementById('install-log');
            const logContent = logDiv.textContent || logDiv.innerText;

            // Check for admin creation failures
            const adminFailed = logContent.includes('Admin creation failed') ||
                               logContent.includes('Could not create admin');

            logDiv.innerHTML += '\n\n' +
                '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' +
                '‚úÖ Installation Complete!\n' +
                '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';

            if (redirectUrl) {
                if (adminFailed) {
                    logDiv.innerHTML +=
                        '‚ö†Ô∏è  Admin account creation failed (see logs above).\n' +
                        'üîß Create admin manually after launching STING:\n' +
                        '   sudo msting create admin ' + adminEmail + '\n\n';
                } else {
                    logDiv.innerHTML +=
                        'üêù Admin account created: ' + adminEmail + '\n' +
                        'üîê Check your email for the magic link to verify and set up security.\n\n';
                }

                // Add Launch button to navigation area
                const nextBtn = document.getElementById('next-btn');
                nextBtn.textContent = 'üöÄ Launch STING';
                nextBtn.style.display = 'block';
                nextBtn.classList.remove('bg-amber-400', 'hover:bg-amber-500');
                nextBtn.classList.add('bg-lime-500', 'hover:bg-lime-600', 'font-bold', 'text-lg', 'px-8', 'py-3');
                nextBtn.onclick = async () => {
                    // Shutdown wizard server gracefully
                    nextBtn.disabled = true;
                    nextBtn.textContent = 'üöÄ Launching...';
                    try {
                        await fetch('/api/shutdown', { method: 'POST' });
                    } catch (e) {
                        // Expected - server is shutting down
                    }
                    // Wait a moment for server to shutdown, then redirect
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 1500);
                };
            } else {
                logDiv.innerHTML +=
                    'üí° This was a dev mode test - configuration saved but not installed.\n' +
                    'üìù Review the output above for production deployment instructions.\n';
            }
        }

        function showInstallError(error) {
            const statusSpan = document.getElementById('install-status');
            const logDiv = document.getElementById('install-log');

            statusSpan.textContent = 'Installation Failed ‚ùå';
            logDiv.innerHTML += '\n\n' +
                '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' +
                '‚ùå Installation Failed\n' +
                '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n' +
                'Error: ' + error + '\n\n' +
                'Please check the logs above for more details.\n';
        }
    </script>
</body>
</html>
